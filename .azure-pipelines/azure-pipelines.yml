# GILDIHUB-UI — Azure Pipelines (dual-mode, default self-hosted) — Node 20
# Branch: main
trigger:
  - main

pr:
  - main

# Standardverdier (kan overrides i "Run pipeline" → Variables)
variables:
  NODE_VERSION: '20.x'
  USE_SELF_HOSTED: 'true'   # <— default til self-hosted agent nå

# To alternative jobber; den som matcher condition kjøres
jobs:
# Hosted (deaktivert når USE_SELF_HOSTED == 'true')
- job: hosted
  displayName: "Build (Hosted Agent)"
  condition: ne(variables['USE_SELF_HOSTED'], 'true')
  pool:
    vmImage: 'windows-latest'
  steps:
  - checkout: self
    fetchDepth: 0
  - task: NodeTool@0
    displayName: "Use Node $(NODE_VERSION)"
    inputs:
      versionSpec: '$(NODE_VERSION)'

  - powershell: |
      Write-Host "== Install & Build (Hosted) =="
      if (Test-Path package.json) {
        npm ci
        try {
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
        } catch {
          Write-Host "Could not parse package.json — skipping build."
          exit 0
        }
        if ($pkg.scripts -and $pkg.scripts.PSObject.Properties.Name -contains 'build') {
          npm run build
        } else {
          Write-Host "No build script defined — skipping build."
        }
      } else {
        Write-Host "No package.json at repo root — nothing to build."
      }
    displayName: "Install & Build"

# Self-hosted (default nå)
- job: selfhosted
  displayName: "Build (Self-hosted Agent)"
  condition: eq(variables['USE_SELF_HOSTED'], 'true')
  pool:
    name: Default            # din lokale agent-pool
  steps:
  - checkout: self
    fetchDepth: 0
  - task: NodeTool@0
    displayName: "Use Node $(NODE_VERSION)"
    inputs:
      versionSpec: '$(NODE_VERSION)'

  - powershell: |
      Write-Host "== Install & Build (Self-hosted) =="
      if (Test-Path package.json) {
        npm ci
        try {
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
        } catch {
          Write-Host "Could not parse package.json — skipping build."
          exit 0
        }
        if ($pkg.scripts -and $pkg.scripts.PSObject.Properties.Name -contains 'build') {
          npm run build
        } else {
          Write-Host "No build script defined — skipping build."
        }
      } else {
        Write-Host "No package.json at repo root — nothing to build."
      }
    displayName: "Install & Build"
